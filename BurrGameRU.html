<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Burr Game: Shooter V5.0.2 (Pixel)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            overflow: hidden; 
            font-family: 'monospace', 'Courier New', monospace; /* –ü–ò–ö–°–ï–õ–¨–ù–´–ô –®–†–ò–§–¢ */
            touch-action: none; 
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #87CEEB; 
            border: 2px solid #000;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        /* --- –ú–µ–Ω—é --- */
        #menuScreen {
            background-color: white; 
        }

        #menuImage {
            max-width: 80%;
            max-height: 50vh; 
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .menu-button {
            padding: 15px 40px;
            font-size: 24px;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.1s;
            width: 300px;
            max-width: 80%;
        }

        #startButton {
            background-color: #4CAF50;
            box-shadow: 0 4px #2E7D32;
        }
        #startButton:active {
            box-shadow: 0 2px #2E7D32;
            transform: translateY(2px);
        }

        #wardrobeButton {
            background-color: #FF9800;
            box-shadow: 0 4px #E65100;
        }
        #wardrobeButton:active {
            box-shadow: 0 2px #E65100;
            transform: translateY(2px);
        }
        
        #autoModeButton {
            background-color: #00BCD4;
            box-shadow: 0 4px #0097A7;
            cursor: default; 
            opacity: 0.6;
        }

        /* --- –ì–∞—Ä–¥–µ—Ä–æ–± --- */
        #wardrobeScreen h2 {
            margin-bottom: 20px;
            font-size: 36px;
        }
        
        #wardrobeTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #555;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #ccc;
            font-size: 18px;
            transition: color 0.2s, background 0.2s;
        }
        .tab-button.active {
            color: white;
            background-color: #555;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        #skinContainer, #bulletContainer {
            display: none; 
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 10px;
        }
        #skinContainer.active, #bulletContainer.active {
            display: flex;
        }

        .skin-option {
            width: 100px;
            height: 100px;
            border: 5px solid transparent;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #222;
            padding: 5px;
            display: flex; 
            justify-content: center;
            align-items: center;
            box-sizing: content-box;
        }
        
        .skin-color {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        
        .bullet-preview {
            width: 80%;
            height: 30%;
            border-radius: 5px;
        }

        .skin-option.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 15px #4CAF50;
        }

        #backToMenuButton {
             background-color: #F44336;
             box-shadow: 0 4px #D32F2F;
        }
        #backToMenuButton:active {
             box-shadow: 0 2px #D32F2F;
             transform: translateY(2px);
        }

        /* --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ --- */
        #uiLayer {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
            pointer-events: none;
        }
        
        .heart {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin-right: 5px;
            image-rendering: pixelated; 
        }
        
        /* –ß–∞—Ç –¥–ª—è –ø–∞—Å—Ö–∞–ª–∫–∏ */
        #chatBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            font-size: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            white-space: nowrap;
        }

        /* --- –ö–æ–Ω—Ç—Ä–æ–ª—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 120px;
            pointer-events: none; 
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            background-color: rgba(255, 255, 255, 0.8);
            transform: scale(0.95);
        }

        #btnJump { background-color: rgba(255, 255, 0, 0.4); }
        #btnShoot { background-color: rgba(255, 0, 0, 0.4); }
    </style>
</head>
<body>

    <div id="menuScreen" class="game-screen">
        <h1 style="color:#FF9800;">BURR GAME V5.0.2</h1>
        <p style="color:black;">(Pixel Edition)</p>
        <button id="startButton" class="menu-button">–ò–ì–†–ê–¢–¨</button>
        <button id="wardrobeButton" class="menu-button">–ì–ê–†–î–ï–†–û–ë</button>
        <button id="autoModeButton" class="menu-button">–ê–í–¢–û (–í –†–ê–ó–†–ê–ë–û–¢–ö–ï)</button>
        <p style="margin-top:10px; color:#666;">(–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –∏–ª–∏ –ø—Ä–æ–±–µ–ª)</p>
        <p style="margin-top:10px; color:#4CAF50;">–†–µ–∫–æ—Ä–¥: <span id="highScore">0</span></p>
    </div>

    <div id="wardrobeScreen" class="game-screen" style="display:none;">
        <h2>–ì–ê–†–î–ï–†–û–ë</h2>
        
        <div id="wardrobeTabs">
            <button id="tabColors" class="tab-button active">–¶–í–ï–¢–ê</button>
            <button id="tabBullets" class="tab-button">–ü–£–õ–ò</button>
        </div>

        <div id="skinContainer" class="active"></div>
        <div id="bulletContainer"></div>

        <button id="backToMenuButton" class="menu-button">–ù–ê–ó–ê–î –í –ú–ï–ù–Æ</button>
    </div>


    <canvas id="gameCanvas"></canvas>

    <div id="infoIcon">i</div>
    <div id="infoText">–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä & Gemini 3 Pro (V5.0.2)</div>
    <div id="chatBox"></div>

    <div id="uiLayer"></div>

    <div id="controls" style="display:none;">
        <div class="control-group">
            <div class="btn" id="btnLeft">‚¨ÖÔ∏è</div>
            <div class="btn" id="btnRight">‚û°Ô∏è</div>
        </div>
        <div class="control-group">
            <div class="btn" id="btnShoot">üî´</div>
            <div class="btn" id="btnJump">‚¨ÜÔ∏è</div>
        </div>
    </div>

    <script>
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –ò –ó–ê–ì–†–£–ó–ö–ê –†–ï–°–£–†–°–û–í ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // V5.1: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Å–∫–∏–Ω–æ–≤
        const availableSkins = [
            { id: 'cube_red', name: '–ö—Ä–∞—Å–Ω—ã–π', color: '#FF0000' }, 
            { id: 'cube_grey', name: '–°–µ—Ä—ã–π', color: '#808080' }, 
            { id: 'cube_pink', name: '–†–æ–∑–æ–≤—ã–π', color: '#FFC0CB' },
            { id: 'cube_beige', name: '–ë–µ–∂–µ–≤—ã–π', color: '#F5F5DC' }, 
            { id: 'cube_white', name: '–ë–µ–ª—ã–π', color: '#FFFFFF' }, 
            { id: 'cube_brown', name: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π', color: '#A52A2A' },
            { id: 'cube_gold', name: '–ó–æ–ª–æ—Ç–æ–π', color: '#FFD700' },       
            { id: 'cube_purple', name: '–ü—É—Ä–ø—É—Ä–Ω—ã–π', color: '#800080' },  
            { id: 'cube_teal', name: '–ë–∏—Ä—é–∑–æ–≤—ã–π', color: '#008080' }      
        ];
        
        // V5.1: –¶–≤–µ—Ç–∞ –ø—É–ª—å
        const availableBulletColors = [
            { id: 'bullet_yellow', name: '–ñ–µ–ª—Ç—ã–π', color: '#FFFF00' },
            { id: 'bullet_black', name: '–ß–µ—Ä–Ω—ã–π', color: '#000000' }, 
            { id: 'bullet_white', name: '–ë–µ–ª—ã–π', color: '#FFFFFF' }   
        ];

        let currentSkinId = 'cube_red'; 
        let currentSkinColor = '#FF0000'; 
        let currentBulletId = 'bullet_yellow';
        let currentBulletColor = '#FFFF00'; 

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
        const assets = {
            ground: new Image(),
            bullet: new Image(),
            spike: new Image(),
        };

        assets.ground.src = '67.png';
        assets.bullet.src = '69.png';
        assets.spike.src = '65.png';

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 2. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï ---

        let gameState = 'MENU';
        const GRAVITY = 0.8; 
        const TERMINAL_VELOCITY = 15;
        const TILE_SIZE = 50; 
        
        const player = {
            x: 100,
            y: 100,
            width: TILE_SIZE,
            height: TILE_SIZE,
            vx: 0,
            vy: 0,
            speed: 7, 
            jumpPower: -16, 
            grounded: false,
            hp: 3,
            maxHp: 3,
            facingRight: true,
            invulnerable: 0,
            cooldownTimer: 0,
            jumpsLeft: 1, 
            maxJumps: 2
        };

        let bullets = [];
        let enemies = []; 
        let targets = []; 
        let platforms = []; 
        let cameraX = 0;
        let score = 0;
        let highScore = localStorage.getItem('burr_highScore') || 0;
        let lastScoredBlock = 0; 

        // V5.1: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ü–∞—Å—Ö–∞–ª–∫–∏
        let pusheenSpawned = false;
        let pusheenDefeated = false;
        const pusheenEnemy = { x: -300, y: canvas.height - TILE_SIZE - 50, width: 50, height: 50, hp: 50, type: 'pusheen' };

        const keys = { left: false, right: false, up: false, shoot: false };
        let canShoot = true; 
        const shootCooldown = 15; 

        // V5.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞
        window.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') {
                if(gameState === 'MENU' && e.code === 'Space') startGame();
                else keys.up = true;
            }
            if (e.code === 'KeyZ' || e.code === 'KeyE') keys.shoot = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') keys.up = false;
            if (e.code === 'KeyZ' || e.code === 'KeyE') keys.shoot = false;
        });

        // –¢–∞—á –∫–Ω–æ–ø–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        const addTouch = (id, keyName, isTap = false) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                keys[keyName] = true; 
            });
            el.addEventListener('touchend', (e) => { 
                e.preventDefault(); 
                keys[keyName] = false; 
            });
            el.addEventListener('mousedown', (e) => { keys[keyName] = true; });
            el.addEventListener('mouseup', (e) => { keys[keyName] = false; });
            el.addEventListener('mouseleave', (e) => { keys[keyName] = false; });
        };

        addTouch('btnLeft', 'left');
        addTouch('btnRight', 'right');
        addTouch('btnJump', 'up');
        addTouch('btnShoot', 'shoot', true); 

        // --- –§—É–Ω–∫—Ü–∏–∏ —Å–º–µ–Ω—ã —ç–∫—Ä–∞–Ω–æ–≤ (–° –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º high score) ---

        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.style.display = 'none';
            });
            const infoText = document.getElementById('infoText');
            infoText.style.display = 'none'; 
            
            document.getElementById(screenId).style.display = (screenId === 'gameCanvas' || screenId === 'menuScreen' || screenId === 'wardrobeScreen') ? 'flex' : 'block';
            
            document.getElementById('controls').style.display = (screenId === 'gameCanvas') ? 'flex' : 'none';
        }

        function showMenu() {
            gameState = 'MENU';
            showScreen('menuScreen');
            document.getElementById('highScore').textContent = localStorage.getItem('burr_highScore') || 0;
        }

        function showWardrobe() {
            gameState = 'WARDROBE';
            showScreen('wardrobeScreen');
            renderSkins();
            renderBulletColors();
            setActiveTab('Colors'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        function startGame() {
            gameState = 'PLAYING';
            showScreen('gameCanvas'); 
            initLevel();
            loop();
        }

        // --- –ì–∞—Ä–¥–µ—Ä–æ–± (–û–ë–ù–û–í–õ–ï–ù–û: –î–≤–µ —Å–µ–∫—Ü–∏–∏) ---

        document.getElementById('tabColors').addEventListener('click', () => setActiveTab('Colors'));
        document.getElementById('tabBullets').addEventListener('click', () => setActiveTab('Bullets'));

        function setActiveTab(tab) {
            document.getElementById('tabColors').classList.remove('active');
            document.getElementById('tabBullets').classList.remove('active');
            document.getElementById('skinContainer').classList.remove('active');
            document.getElementById('bulletContainer').classList.remove('active');

            if (tab === 'Colors') {
                document.getElementById('tabColors').classList.add('active');
                document.getElementById('skinContainer').classList.add('active');
            } else {
                document.getElementById('tabBullets').classList.add('active');
                document.getElementById('bulletContainer').classList.add('active');
            }
        }

        function renderSkins() {
            const container = document.getElementById('skinContainer');
            container.innerHTML = '';

            availableSkins.forEach(skin => {
                const div = document.createElement('div');
                div.className = 'skin-option';
                if (currentSkinId === skin.id) {
                    div.classList.add('selected');
                }
                div.setAttribute('data-skin-id', skin.id);
                div.onclick = () => selectSkin(skin.id, skin.color);

                const colorDiv = document.createElement('div');
                colorDiv.className = 'skin-color';
                colorDiv.style.backgroundColor = skin.color;
                div.appendChild(colorDiv);
                
                container.appendChild(div);
            });
        }

        function renderBulletColors() {
            const container = document.getElementById('bulletContainer');
            container.innerHTML = '';

            availableBulletColors.forEach(bullet => {
                const div = document.createElement('div');
                div.className = 'skin-option';
                if (currentBulletId === bullet.id) {
                    div.classList.add('selected');
                }
                div.setAttribute('data-bullet-id', bullet.id);
                div.onclick = () => selectBulletColor(bullet.id, bullet.color);

                const colorDiv = document.createElement('div');
                colorDiv.className = 'bullet-preview';
                colorDiv.style.backgroundColor = bullet.color;
                div.appendChild(colorDiv);
                
                container.appendChild(div);
            });
        }

        function selectSkin(skinId, color) {
            currentSkinId = skinId;
            currentSkinColor = color; 
            document.querySelectorAll('#skinContainer .skin-option').forEach(el => {
                el.classList.remove('selected');
                if (el.getAttribute('data-skin-id') === skinId) {
                    el.classList.add('selected');
                }
            });
        }
        
        function selectBulletColor(bulletId, color) {
            currentBulletId = bulletId;
            currentBulletColor = color; 
            document.querySelectorAll('#bulletContainer .skin-option').forEach(el => {
                el.classList.remove('selected');
                if (el.getAttribute('data-bullet-id') === bulletId) {
                    el.classList.add('selected');
                }
            });
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é/–≥–∞—Ä–¥–µ—Ä–æ–±–∞ –∏ –∏–∫–æ–Ω–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('wardrobeButton').addEventListener('click', showWardrobe);
        document.getElementById('backToMenuButton').addEventListener('click', showMenu);
        
        const infoIcon = document.getElementById('infoIcon');
        const infoText = document.getElementById('infoText');

        infoIcon.addEventListener('click', () => {
            if (infoText.style.display === 'none' || infoText.style.display === '') {
                infoText.style.display = 'block';
            } else {
                infoText.style.display = 'none';
            }
        });
        
        const chatBox = document.getElementById('chatBox');

        function showChat(message, duration = 2000) {
            chatBox.textContent = message;
            chatBox.style.opacity = '1';
            setTimeout(() => {
                chatBox.style.opacity = '0';
            }, duration);
        }

        // --- 3. –õ–û–ì–ò–ö–ê –ò–ì–†–´ –ò –ö–û–õ–õ–ò–ó–ò–ò (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ) ---

        function initLevel() {
            player.hp = 3;
            player.x = 100;
            player.y = 100;
            player.vx = 0;
            player.vy = 0;
            player.jumpsLeft = player.maxJumps;
            bullets = [];
            targets = [];
            enemies = [];
            score = 0;
            lastScoredBlock = 0;
            pusheenSpawned = false;
            pusheenDefeated = false;
            
            updateHearts();

            platforms = [];
            
            // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–µ–º–ª—è (5 –±–ª–æ–∫–æ–≤)
            for(let i=0; i<5; i++) {
                platforms.push({ x: i * TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –ø–∞—Å—Ö–∞–ª–∫–∏ –Ω–∞–∑–∞–¥
            platforms.push({ x: -TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE });
            platforms.push({ x: -2*TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE });
            platforms.push({ x: -3*TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE });


            let currentX = 5 * TILE_SIZE;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è
            for(let i=0; i<80; i++) {
                const rand = Math.random();

                if (rand < 0.2) { 
                    currentX += TILE_SIZE * 2;
                } else if (rand < 0.8) {
                    let length = Math.floor(Math.random() * 4) + 2; 
                    let platformStartY = canvas.height - TILE_SIZE;
                    
                    for(let j=0; j<length; j++) {
                        platforms.push({ x: currentX, y: platformStartY, width: TILE_SIZE, height: TILE_SIZE });
                        
                        if (j === Math.floor(length/2) && Math.random() < 0.5) {
                            targets.push({
                                x: currentX,
                                y: platformStartY - TILE_SIZE,
                                width: TILE_SIZE,
                                height: TILE_SIZE,
                                hp: 2
                            });
                        }
                        
                        if (j === 0 && length >= 3 && Math.random() < 0.3) {
                            enemies.push({
                                x: currentX + 10, 
                                y: platformStartY - 30, 
                                width: 30,
                                height: 30,
                                type: 'spike'
                            });
                        }

                        currentX += TILE_SIZE;
                    }
                    
                    if (length > 3) {
                        currentX += TILE_SIZE * 2;
                    }

                } else {
                    currentX += TILE_SIZE * 3;
                    let pX = currentX;
                    let pY = canvas.height - TILE_SIZE * (Math.floor(Math.random() * 3) + 3);
                    
                    platforms.push({ x: pX, y: pY, width: TILE_SIZE * 2, height: TILE_SIZE });
                    
                    if (Math.random() < 0.5) {
                         enemies.push({
                            x: pX + 10, 
                            y: pY - 30,
                            width: 30,
                            height: 30,
                            type: 'spike'
                        });
                    }
                    
                    if (Math.random() < 0.5) {
                         targets.push({
                            x: pX + TILE_SIZE, 
                            y: pY - TILE_SIZE,
                            width: TILE_SIZE,
                            height: TILE_SIZE,
                            hp: 2
                        });
                    }

                    currentX += TILE_SIZE * 2;
                }
                currentX += TILE_SIZE; 
            }
        }

        // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π AABB (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function checkCollision(r1, r2) {
            return (r1.x < r2.x + r2.width &&
                    r1.x + r1.width > r2.x &&
                    r1.y < r2.y + r2.height &&
                    r1.y + r1.height > r2.y);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –∏–≥—Ä–æ–∫–∞ (–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Å–±—Ä–æ—Å –ø—Ä—ã–∂–∫–æ–≤)
        function handleSolidCollision(r1, r2) {
            if (!checkCollision(r1, r2)) return false;

            const dx = (r1.x + r1.width / 2) - (r2.x + r2.width / 2);
            const dy = (r1.y + r1.height / 2) - (r2.y + r2.height / 2);
            
            const combinedHalfWidths = r1.width / 2 + r2.width / 2;
            const combinedHalfHeights = r1.height / 2 + r2.height / 2;
            
            const overlapX = combinedHalfWidths - Math.abs(dx);
            const overlapY = combinedHalfHeights - Math.abs(dy);
            
            if (overlapX < overlapY) {
                if (dx > 0) {
                    r1.x += overlapX; 
                } else {
                    r1.x -= overlapX;
                }
                r1.vx = 0;
            } else {
                if (dy > 0) {
                    r1.y += overlapY;
                    r1.vy = 0;
                } else {
                    r1.y -= overlapY;
                    r1.vy = 0;
                    r1.grounded = true;
                    r1.jumpsLeft = r1.maxJumps; 
                }
            }
            return true;
        }


        function shoot() {
            if (gameState !== 'PLAYING' || !canShoot) return;
            
            const bSpeed = player.facingRight ? 15 : -15; 
            
            bullets.push({
                x: player.x + player.width / 2,
                y: player.y + player.height / 2 - 5, 
                vx: bSpeed,
                width: 20,
                height: 10,
                life: 60,
                color: currentBulletColor 
            });
            
            canShoot = false;
            player.cooldownTimer = shootCooldown; 
        }

        function update() {
            if (gameState !== 'PLAYING') return;

            // 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª—å–±–æ–π
            if (keys.shoot) {
                shoot();
            }

            if (player.cooldownTimer > 0) {
                player.cooldownTimer--;
            } else if (player.cooldownTimer === 0) {
                canShoot = true;
            }

            // 2. –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∏ –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
            if (keys.left) { player.vx = -player.speed; player.facingRight = false; } 
            else if (keys.right) { player.vx = player.speed; player.facingRight = true; } 
            else { player.vx = 0; }

            // –õ–æ–≥–∏–∫–∞ –ø—Ä—ã–∂–∫–∞ –∏ –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞
            if (keys.up) {
                if (player.grounded) {
                    player.vy = player.jumpPower;
                    player.grounded = false;
                    player.jumpsLeft--;
                } else if (player.jumpsLeft > 0) {
                    player.vy = player.jumpPower; 
                    player.jumpsLeft--;
                }
            }
            if (player.vy < 0) {
                keys.up = false;
            }


            player.vy += GRAVITY;
            if(player.vy > TERMINAL_VELOCITY) player.vy = TERMINAL_VELOCITY;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            player.x += player.vx;
            player.y += player.vy;

            // 3. –ü–∞—Å—Ö–∞–ª–∫–∞ (Pusheen)
            if (!pusheenSpawned && player.x < 50) {
                pusheenSpawned = true;
                enemies.push(pusheenEnemy);
                showChat('Pusheen: "—è –≤–∏–∂—É —Ç–µ–±—è. –ê —Ç—ã –º–µ–Ω—è?"');
            }
            
            if (pusheenSpawned && !pusheenDefeated) {
                if (pusheenEnemy.hp <= 0 && !pusheenDefeated) {
                    pusheenDefeated = true;
                    showChat('–ò–≥—Ä–æ–∫: "–î–∞–∂–µ –Ω–µ –≤—Å–ø–æ—Ç–µ–ª!"', 2500);
                    setTimeout(() => {
                        showChat('Pusheen: "–ø—Ä–∏–∏–≤–µ–µ–µ—Ç!!"');
                    }, 3000);
                }
            }
            

            // 4. –ö–æ–ª–ª–∏–∑–∏–∏ 
            player.grounded = false;
            
            platforms.forEach(p => handleSolidCollision(player, p));
            targets.forEach(t => handleSolidCollision(player, t));


            // 5. –£–ø–∞–ª –≤ –ø—Ä–æ–ø–∞—Å—Ç—å
            if (player.y > canvas.height + 100) {
                takeDamage(3);
            }
            
            // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ
            const currentBlock = Math.floor(player.x / TILE_SIZE);
            if (currentBlock > lastScoredBlock + 3) {
                score += 10;
                lastScoredBlock = currentBlock;
            }


            // 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—É–ª—å –∏ –ö–æ–ª–ª–∏–∑–∏–∏ –ü—É–ª—è-–¶–µ–ª—å
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx;
                b.life--;
                
                let hitTarget = false;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–µ–π (–°–∏–Ω–∏–µ –∫—É–±–∏–∫–∏)
                for (let j = targets.length - 1; j >= 0; j--) {
                    let t = targets[j];
                    if (checkCollision(b, t)) {
                        t.hp--;
                        score += 5; 
                        hitTarget = true;
                        
                        if (t.hp <= 0) {
                            targets.splice(j, 1);
                            score += 50;
                        }
                        break; 
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ Pusheen
                if (pusheenSpawned && !pusheenDefeated && checkCollision(b, pusheenEnemy)) {
                    pusheenEnemy.hp--;
                    score += 1; 
                    hitTarget = true;
                }


                // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–ª–∏
                if (b.life <= 0 || hitTarget) {
                    bullets.splice(i, 1);
                    continue;
                }
            }

            // 7. –®–∏–ø—ã (–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–Ω–∞)
            if (player.invulnerable > 0) player.invulnerable--;

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                if (checkCollision(player, e)) {
                    if (e.type === 'spike') {
                        takeDamage(1);
                        break;
                    } else if (e.type === 'pusheen' && !pusheenDefeated) {
                        takeDamage(3); 
                        break;
                    }
                }
                
                // –£–¥–∞–ª—è–µ–º Pusheen –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã
                if (e.type === 'pusheen' && pusheenDefeated) {
                    enemies.splice(i, 1);
                }
            }

            // 8. –ö–∞–º–µ—Ä–∞
            let targetCamX = player.x - canvas.width / 2 + player.width / 2;
            if (targetCamX < 0) targetCamX = 0;
            cameraX += (targetCamX - cameraX) * 0.1; 
        }

        // --- –£—Ä–æ–Ω –∏ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–° –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º high score) ---

        function takeDamage(amount) {
            if (player.invulnerable > 0) return;

            player.hp -= amount;
            player.invulnerable = 60; 
            player.vy = -5; 
            
            updateHearts();

            if (player.hp <= 0) {
                gameState = 'GAMEOVER';
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('burr_highScore', highScore);
                }
                showCustomMessage(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ${score}. –†–µ–∫–æ—Ä–¥: ${highScore}`, () => {
                    location.reload();
                });
            }
        }

        function showCustomMessage(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100; display:flex; justify-content:center; align-items:center;';
            const box = document.createElement('div');
            box.style.cssText = 'background:white; padding:30px; border-radius:10px; text-align:center; font-size:20px; color:#333; max-width: 80%; font-family: monospace;';
            const buttonCallback = callback.toString().replace('function () {', '').replace('}', '');
            box.innerHTML = `<p>${message}</p><button onclick="this.parentNode.parentNode.remove(); ${buttonCallback}" style="padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:5px; margin-top:15px; cursor:pointer; font-family: monospace;">–û–ö</button>`;
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        function updateHearts() {
            const ui = document.getElementById('uiLayer');
            ui.innerHTML = '';
            for(let i=0; i<player.hp; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.innerHTML = '‚ô•Ô∏è'; /* V5.0.2: –ò–∑–º–µ–Ω–µ–Ω–æ —Å ‚ù§Ô∏è –Ω–∞ ‚ô•Ô∏è */
                heart.style.fontSize = '30px';
                ui.appendChild(heart);
            }
        }

        // --- 4. –û–¢–†–ò–°–û–í–ö–ê (–û–ë–ù–û–í–õ–ï–ù–û) ---

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0);

            // –†–∏—Å—É–µ–º –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
            for (let p of platforms) {
                if (assets.ground.complete && assets.ground.naturalHeight !== 0) {
                     ctx.drawImage(assets.ground, p.x, p.y, p.width, p.height);
                } else {
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(p.x, p.y, p.width, p.height);
                    ctx.fillStyle = '#00FF00'; 
                    ctx.fillRect(p.x, p.y, p.width, 10);
                }
            }

            // –†–∏—Å—É–µ–º –¶–µ–ª–∏ (–°–∏–Ω–∏–µ –ö—É–±–∏–∫–∏)
            for (let t of targets) {
                ctx.fillStyle = `rgba(0, 0, 255, ${t.hp / 2})`; 
                ctx.fillRect(t.x, t.y, t.width, t.height);
                if (assets.ground.complete && assets.ground.naturalHeight !== 0) {
                    ctx.globalAlpha = 0.2; 
                    ctx.drawImage(assets.ground, t.x, t.y, t.width, t.height);
                    ctx.globalAlpha = 1.0;
                }
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px monospace';
                ctx.fillText(t.hp, t.x + t.width / 2 - 5, t.y + t.height / 2 + 5);
            }

            // –†–∏—Å—É–µ–º –®–∏–ø—ã –∏ Pusheen
            for (let e of enemies) {
                if (e.type === 'spike') {
                    if (assets.spike.complete && assets.spike.naturalHeight !== 0) {
                        ctx.drawImage(assets.spike, e.x, e.y, e.width, e.height);
                    } else {
                        ctx.fillStyle = 'purple';
                        ctx.beginPath();
                        ctx.moveTo(e.x, e.y + e.height);
                        ctx.lineTo(e.x + e.width/2, e.y);
                        ctx.lineTo(e.x + e.width, e.y + e.height);
                        ctx.fill();
                    }
                } else if (e.type === 'pusheen') {
                    if (!pusheenDefeated) {
                        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ Pusheen (–∑–ª–æ–¥–µ–π)
                        ctx.fillStyle = 'darkred'; 
                        ctx.fillRect(e.x, e.y, e.width, e.height);
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 16px monospace';
                        ctx.fillText(`BOSS ${e.hp}`, e.x, e.y - 5);
                    } else {
                        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ Pusheen (–º–∏–ª—ã–π –∫–æ—Ç–∏–∫)
                        ctx.fillStyle = 'pink'; 
                        ctx.fillRect(e.x, e.y, e.width, e.height);
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 16px monospace';
                        ctx.fillText(`PUSHEEN`, e.x, e.y - 5);
                    }
                }
            }

            // –†–∏—Å—É–µ–º –ü—É–ª–∏ (V5.1: –¶–≤–µ—Ç –ø—É–ª–∏)
            for (let b of bullets) {
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x, b.y, b.width, b.height);
            }

            // –†–∏—Å—É–µ–º –ò–≥—Ä–æ–∫–∞
            if (player.invulnerable % 10 < 5) { 
                ctx.fillStyle = currentSkinColor; 
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
            
            // V5.1: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä—ã–∂–∫–∞
            if (!player.grounded && player.jumpsLeft > 0) {
                const barX = player.x + player.width / 2 - 25;
                const barY = player.y - 15;
                const barW = 50;
                const barH = 5;
                const jumpRatio = player.jumpsLeft / player.maxJumps;
                
                // –ö—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∞ (–æ–±—â–∏–π –ø—Ä—ã–∂–æ–∫)
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                ctx.fillRect(barX, barY, barW, barH);
                
                // –ó–µ–ª–µ–Ω–∞—è –ø–æ–ª–æ—Å–∞ (–¥–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫)
                if (player.jumpsLeft === 1) { 
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
                    ctx.fillRect(barX + barW * (1 - jumpRatio), barY, barW * jumpRatio, barH);
                }

                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(barX, barY, barW, barH);
            }


            // –†–∏—Å—É–µ–º –í–µ—Ä—Å–∏—é –∏ –°—á–µ—Ç
            ctx.restore();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.font = 'bold 16px monospace';
            ctx.fillText('V5.0.2', canvas.width - 70, 20); /* V5.0.2: –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è */

            ctx.fillStyle = '#333';
            ctx.fillText(`–°–ß–ï–¢: ${score}`, 10, 50);
            ctx.fillText(`–†–ï–ö–û–†–î: ${highScore}`, 10, 70);
        }

        // –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ
        function loop() {
            update();
            draw();
            if (gameState === 'PLAYING') {
                requestAnimationFrame(loop);
            }
        }

        window.onload = function() {
            showMenu();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
            const initialSkin = availableSkins.find(skin => skin.id === currentSkinId);
            if(initialSkin) { currentSkinColor = initialSkin.color; }
            const initialBullet = availableBulletColors.find(b => b.id === currentBulletId);
            if(initialBullet) { currentBulletColor = initialBullet.color; }
        };

    </script>
</body>
</html>
