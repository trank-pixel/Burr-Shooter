<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Burr Game: Shooter V5.1 Beta</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1c1e; /* M3 Dark background */
            overflow: hidden; 
            font-family: 'monospace', 'Courier New', monospace;
            touch-action: none; 
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #87CEEB; 
            border: 2px solid #000;
        }

        /* --- M3 STYLES --- */
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º –∏ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 28, 30, 0.95); /* –ü–æ—á—Ç–∏ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: #e2e2e6;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–µ–Ω—é M3 */
        .menu-container {
            background-color: #2c2e30;
            padding: 30px;
            border-radius: 28px; /* M3 Large rounding */
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 32px; color: #ffb74d; }
        h2 { margin: 0; font-size: 24px; color: #e2e2e6; }
        h3 { margin: 10px 0 5px; font-size: 18px; color: #c4c7c5; }

        /* –ö–ù–û–ü–ö–ò M3 Expressive (Pills) */
        .menu-button {
            padding: 15px 24px;
            font-size: 18px;
            border: none;
            border-radius: 50px; /* –ü–æ–ª–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ (Pill shape) */
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.2s, background-color 0.2s;
            font-family: inherit;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-button:active {
            transform: scale(0.96);
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã –∫–Ω–æ–ø–æ–∫ M3 */
        .btn-primary { background-color: #a8c7fa; color: #062e6f; } /* Play Normal */
        .btn-secondary { background-color: #d7c0ff; color: #3b0090; } /* Wardrobe/Bullets */
        .btn-danger { background-color: #ffb4ab; color: #690005; } /* Hardcore/Back */
        .btn-warning { background-color: #ffdcbe; color: #5d4200; } /* Hardened */
        .btn-info { background-color: #4fd8eb; color: #00363d; } /* Auto */
        .btn-toggle { position: absolute; top: 20px; right: 20px; width: auto; font-size: 14px; padding: 10px 20px; z-index: 100; }

        /* –°–µ—Ç–∫–∏ –¥–ª—è –≥–∞—Ä–¥–µ—Ä–æ–±–∞ */
        .grid-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-card {
            width: 70px;
            height: 70px;
            border-radius: 16px; /* M3 Medium rounding */
            background-color: #43474e;
            border: 3px solid transparent;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            position: relative;
        }

        .option-card.selected {
            border-color: #a8c7fa;
            background-color: #33363b;
            box-shadow: 0 0 0 4px rgba(168, 199, 250, 0.3);
        }

        .color-preview { width: 40px; height: 40px; border-radius: 12px; }
        .shape-preview { width: 40px; height: 40px; background-color: #fff; }

        /* UI Layer */
        #uiLayer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 5;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
        }
        
        /* –ß–∞—Ç */
        #chatBox {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #1a1c1e;
            border: 1px solid #43474e;
            color: #e2e2e6;
            border-radius: 16px;
            font-size: 16px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        /* Controls */
        #controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            height: 100px;
            pointer-events: none; 
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        .btn {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px; /* Squircle */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            user-select: none;
            cursor: pointer;
            color: white;
        }
        
        .btn:active { background-color: rgba(255, 255, 255, 0.4); transform: scale(0.95); }
        #btnShoot { background-color: rgba(255, 100, 100, 0.3); }
        #btnJump { background-color: rgba(255, 255, 100, 0.3); }

        /* Game Over Modal */
        #gameOverModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #2c2e30;
            padding: 40px;
            border-radius: 28px;
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>

    <div id="menuScreen" class="game-screen">
        <div class="menu-container">
            <h1>BURR GAME V5.1</h1>
            <p style="color:#c4c7c5; font-size: 14px;">(Beta: M3 Style + Auto)</p>

            <h3>–†–µ–∂–∏–º –∏–≥—Ä—ã:</h3>
            <button class="menu-button btn-primary" onclick="startGame('normal')">‚ñ∂ –û–±—ã—á–Ω—ã–π (V5.0.2)</button>
            <button class="menu-button btn-warning" onclick="startGame('hardened')">‚ö° –£—Å–ª–æ–∂–Ω—ë–Ω–Ω—ã–π (HP x5)</button>
            <button class="menu-button btn-danger" onclick="startGame('hardcore')">üíÄ –•–∞—Ä–¥–∫–æ—Ä (1 HP)</button>
            <button class="menu-button btn-info" onclick="startGame('auto')">ü§ñ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç</button>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="menu-button btn-secondary" onclick="openWardrobe()" style="flex:1;">üëï –°–∫–∏–Ω—ã</button>
                <button class="menu-button btn-secondary" onclick="openBulletSettings()" style="flex:1;">üî´ –ü—É–ª–∏</button>
            </div>
            
            <p style="margin-top:5px; color:#4CAF50;">–†–µ–∫–æ—Ä–¥: <span id="highScore">0</span></p>
        </div>
    </div>

    <div id="wardrobeScreen" class="game-screen" style="display:none;">
        <div class="menu-container">
            <h2>–ì–ê–†–î–ï–†–û–ë</h2>
            <div id="skinContainer" class="grid-container"></div>
            <button class="menu-button btn-danger" onclick="showMenu()">–ù–ê–ó–ê–î</button>
        </div>
    </div>
    
    <div id="bulletSettingsScreen" class="game-screen" style="display:none;">
        <div class="menu-container">
            <h2>–ü–£–õ–ò</h2>
            <h3>–¶–≤–µ—Ç:</h3>
            <div id="bulletColorContainer" class="grid-container"></div>
            <h3>–§–æ—Ä–º–∞:</h3>
            <div id="bulletShapeContainer" class="grid-container"></div>
            <button class="menu-button btn-danger" onclick="showMenu()">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <button id="autopilotToggle" class="menu-button btn-danger btn-toggle" onclick="disableAutopilotManual()" style="display:none;">–°–¢–û–ü –ê–í–¢–û</button>
    <div id="uiLayer"></div>
    <div id="chatBox"></div>
    
    <div id="gameOverModal">
        <div class="modal-content">
            <h2 style="color:#F44336">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!</h2>
            <p id="gameOverText" style="font-size:20px; margin: 20px 0;">–°—á–µ—Ç: 0</p>
            <button class="menu-button btn-primary" onclick="location.reload()">–û–ö</button>
        </div>
    </div>

    <div id="controls" style="display:none;">
        <div class="control-group">
            <div class="btn" id="btnLeft">‚Üê</div>
            <div class="btn" id="btnRight">‚Üí</div>
        </div>
        <div class="control-group">
            <div class="btn" id="btnShoot">‚óâ</div>
            <div class="btn" id="btnJump">‚ñ≤</div>
        </div>
    </div>

    <script>
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ò (–ë–ê–ó–ê 5.0.2 + –ù–û–í–û–ï) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –°–∫–∏–Ω—ã (–î–æ–±–∞–≤–ª–µ–Ω—ã –ó–æ–ª–æ—Ç–æ–π –∏ –ë–∏—Ä—é–∑–æ–≤—ã–π)
        const availableSkins = [
            { id: 'cube_red', color: '#FF0000' }, 
            { id: 'cube_grey', color: '#808080' }, 
            { id: 'cube_pink', color: '#FFC0CB' },
            { id: 'cube_beige', color: '#F5F5DC' }, 
            { id: 'cube_white', color: '#FFFFFF' }, 
            { id: 'cube_brown', color: '#A52A2A' },
            { id: 'cube_gold', color: '#FFD700' },       
            { id: 'cube_purple', color: '#800080' },  
            { id: 'cube_teal', color: '#008080' }      
        ];
        
        // –ü—É–ª–∏ (–¶–≤–µ—Ç–∞)
        const availableBulletColors = [
            { id: 'b_yellow', color: '#FFFF00' },
            { id: 'b_black', color: '#000000' }, 
            { id: 'b_white', color: '#FFFFFF' },
            { id: 'b_blue', color: '#0000FF' },
            { id: 'b_green', color: '#00FF00' },
            { id: 'b_purple', color: '#800080' }
        ];

        // –ü—É–ª–∏ (–§–æ—Ä–º—ã)
        const availableBulletShapes = [
            { id: 's_rect', name: '‚ñ†' },
            { id: 's_circle', name: '‚óè' },
            { id: 's_tri', name: '‚ñ≤' }
        ];

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        let currentSkinId = localStorage.getItem('skinId') || 'cube_red';
        let currentSkinColor = localStorage.getItem('skinColor') || '#FF0000';
        let currentBulletColor = localStorage.getItem('bulColor') || '#FFFF00';
        let currentBulletShape = localStorage.getItem('bulShape') || 's_rect';

        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        const assets = { ground: new Image(), bullet: new Image(), spike: new Image() };
        assets.ground.src = '67.png'; assets.bullet.src = '69.png'; assets.spike.src = '65.png';

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 2. –ì–ï–ô–ú–ü–õ–ï–ô (–§–ò–ó–ò–ö–ê 5.0.2 - –ù–ï –¢–†–û–ì–ê–ï–ú!) ---
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–∞ V5.1
        let gameMode = {
            type: 'normal', // normal, hardened, hardcore, auto
            enemyHP: 1,
            speedMult: 1,
            isAuto: false,
            autoState: 'off' // off, active, stopping
        };

        let gameState = 'MENU';
        const GRAVITY = 0.8; 
        const TERMINAL_VELOCITY = 15;
        const TILE_SIZE = 50; 
        
        const player = {
            x: 100, y: 100, width: TILE_SIZE, height: TILE_SIZE,
            vx: 0, vy: 0, speed: 7, jumpPower: -16, 
            grounded: false, hp: 3, maxHp: 3,
            facingRight: true, invulnerable: 0, cooldownTimer: 0,
            jumpsLeft: 1, maxJumps: 2
        };

        let bullets = [], enemies = [], targets = [], platforms = [];
        let cameraX = 0, score = 0, lastScoredBlock = 0;
        let highScore = localStorage.getItem('burr_highScore') || 0;
        
        let pusheenSpawned = false, pusheenDefeated = false;
        const pusheenEnemy = { x: -300, y: canvas.height - TILE_SIZE - 50, width: 50, height: 50, hp: 50, type: 'pusheen' };

        const keys = { left: false, right: false, up: false, shoot: false };
        let canShoot = true; 
        const shootCooldown = 15; 

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
        window.addEventListener('keydown', (e) => {
            // –ï—Å–ª–∏ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –ª—é–±–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –≤—ã–∫–ª—é—á–∞–µ—Ç –µ–≥–æ
            if (gameMode.isAuto && gameMode.autoState === 'active') disableAutopilotManual();

            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') {
                if(gameState === 'MENU' && e.code === 'Space') startGame('normal');
                else keys.up = true;
            }
            if (e.code === 'KeyZ' || e.code === 'KeyE') keys.shoot = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') keys.up = false;
            if (e.code === 'KeyZ' || e.code === 'KeyE') keys.shoot = false;
        });

        const addTouch = (id, keyName) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[keyName] = true; if(gameMode.isAuto) disableAutopilotManual(); });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyName] = false; });
            el.addEventListener('mousedown', (e) => { keys[keyName] = true; });
            el.addEventListener('mouseup', (e) => { keys[keyName] = false; });
        };

        addTouch('btnLeft', 'left'); addTouch('btnRight', 'right');
        addTouch('btnJump', 'up'); addTouch('btnShoot', 'shoot'); 

        // --- –ú–ï–ù–Æ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        function showScreen(id) {
            document.querySelectorAll('.game-screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('autopilotToggle').style.display = 'none';
        }

        function showMenu() {
            gameState = 'MENU';
            showScreen('menuScreen');
            document.getElementById('highScore').textContent = localStorage.getItem('burr_highScore') || 0;
        }

        function openWardrobe() { showScreen('wardrobeScreen'); renderSkins(); }
        function openBulletSettings() { showScreen('bulletSettingsScreen'); renderBulletSettings(); }

        function renderSkins() {
            const c = document.getElementById('skinContainer'); c.innerHTML = '';
            availableSkins.forEach(s => {
                const d = document.createElement('div'); d.className = 'option-card';
                if(currentSkinId === s.id) d.classList.add('selected');
                d.innerHTML = `<div class="color-preview" style="background:${s.color}"></div>`;
                d.onclick = () => { 
                    currentSkinId = s.id; currentSkinColor = s.color;
                    localStorage.setItem('skinId', s.id); localStorage.setItem('skinColor', s.color);
                    renderSkins();
                };
                c.appendChild(d);
            });
        }

        function renderBulletSettings() {
            const cColor = document.getElementById('bulletColorContainer'); cColor.innerHTML = '';
            availableBulletColors.forEach(b => {
                const d = document.createElement('div'); d.className = 'option-card';
                if(currentBulletColor === b.color) d.classList.add('selected');
                d.innerHTML = `<div class="color-preview" style="background:${b.color}"></div>`;
                d.onclick = () => { 
                    currentBulletColor = b.color; localStorage.setItem('bulColor', b.color); renderBulletSettings(); 
                };
                cColor.appendChild(d);
            });

            const cShape = document.getElementById('bulletShapeContainer'); cShape.innerHTML = '';
            availableBulletShapes.forEach(s => {
                const d = document.createElement('div'); d.className = 'option-card';
                if(currentBulletShape === s.id) d.classList.add('selected');
                d.innerHTML = `<div class="shape-preview" style="display:flex;justify-content:center;align-items:center;border-radius:50%;color:black;font-size:20px;">${s.name}</div>`;
                d.onclick = () => { 
                    currentBulletShape = s.id; localStorage.setItem('bulShape', s.id); renderBulletSettings(); 
                };
                cShape.appendChild(d);
            });
        }

        function startGame(mode) {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞
            gameMode.type = mode;
            gameMode.isAuto = (mode === 'auto');
            gameMode.autoState = (mode === 'auto') ? 'active' : 'off';
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (mode === 'normal' || mode === 'auto') {
                gameMode.enemyHP = 1; gameMode.speedMult = 1; player.maxHp = 3;
            } else if (mode === 'hardened') {
                gameMode.enemyHP = 5; gameMode.speedMult = 1.5; player.maxHp = 3;
            } else if (mode === 'hardcore') {
                gameMode.enemyHP = 5; gameMode.speedMult = 2.0; player.maxHp = 1;
            }

            // –°—Ç–∞—Ä—Ç
            document.querySelectorAll('.game-screen').forEach(s => s.style.display = 'none');
            document.getElementById('gameCanvas').style.display = 'block';
            
            if (gameMode.isAuto) {
                document.getElementById('autopilotToggle').style.display = 'block';
                document.getElementById('controls').style.display = 'none';
            } else {
                document.getElementById('controls').style.display = 'flex';
            }

            gameState = 'PLAYING';
            initLevel();
            loop();
        }

        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (V5.1 Update) ---

        function disableAutopilotManual() {
            if(gameMode.autoState === 'active') {
                gameMode.autoState = 'stopping';
                document.getElementById('autopilotToggle').textContent = '–û–°–¢–ê–ù–û–í–ö–ê...';
                showChat("–ò–ò: –ò—â—É –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ...");
            }
        }

        // –£–º–Ω—ã–π –ò–ò
        function runAutopilot() {
            if (gameMode.autoState === 'off') return;
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞" –∏ –º—ã –Ω–∞ –∑–µ–º–ª–µ - —Å—Ç–æ–ø
            if (gameMode.autoState === 'stopping' && player.grounded) {
                gameMode.isAuto = false;
                gameMode.autoState = 'off';
                document.getElementById('autopilotToggle').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                keys.right = false; keys.up = false; keys.shoot = false;
                showChat("–ò–ò: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ!");
                return;
            }

            // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–¥
            const lookAhead = 150;
            let dangerSpike = false;
            let groundAhead = false;
            let targetAhead = false;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∏–ø–æ–≤
            for (let e of enemies) {
                if (e.x > player.x && e.x < player.x + lookAhead) dangerSpike = true;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–º–ª–∏ (—á—Ç–æ–±—ã –Ω–µ —É–ø–∞—Å—Ç—å)
            for (let p of platforms) {
                if (p.x < player.x + lookAhead + 50 && p.x + p.width > player.x + lookAhead) groundAhead = true;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–∞–≥–æ–≤ –¥–ª—è —Å—Ç—Ä–µ–ª—å–±—ã
            for (let t of targets) {
                if (t.x > player.x && t.x < player.x + 400 && Math.abs(t.y - player.y) < 50) targetAhead = true;
            }

            // –î–µ–π—Å—Ç–≤–∏—è
            keys.right = true;
            keys.shoot = targetAhead;

            // –ü—Ä—ã–∂–æ–∫: –µ—Å–ª–∏ —à–∏–ø –∏–ª–∏ –µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ –Ω–µ—Ç –∑–µ–º–ª–∏
            if (dangerSpike || !groundAhead) {
                if (player.grounded) keys.up = true;
                else if (player.jumpsLeft > 0 && player.vy > 0) keys.up = true; // –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ –µ—Å–ª–∏ –ø–∞–¥–∞–µ–º
            } else {
                keys.up = false;
            }
        }

        function initLevel() {
            player.hp = player.maxHp;
            player.x = 100; player.y = 100; player.vx = 0; player.vy = 0;
            player.jumpsLeft = player.maxJumps;
            bullets = []; targets = []; enemies = []; platforms = [];
            score = 0; lastScoredBlock = 0;
            pusheenSpawned = false; pusheenDefeated = false;
            
            updateHearts();

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (–∫–æ–¥ 5.0.2 —Å–æ—Ö—Ä–∞–Ω–µ–Ω)
            for(let i=0; i<5; i++) platforms.push({ x: i * TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE });
            platforms.push({ x: -TILE_SIZE, y: canvas.height - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE }); // Backwards

            let currentX = 5 * TILE_SIZE;
            for(let i=0; i<80; i++) {
                const rand = Math.random();
                if (rand < 0.2) { currentX += TILE_SIZE * 2; } 
                else if (rand < 0.8) {
                    let length = Math.floor(Math.random() * 4) + 2; 
                    let platformStartY = canvas.height - TILE_SIZE;
                    for(let j=0; j<length; j++) {
                        platforms.push({ x: currentX, y: platformStartY, width: TILE_SIZE, height: TILE_SIZE });
                        if (j === Math.floor(length/2) && Math.random() < 0.5) {
                            targets.push({ x: currentX, y: platformStartY - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, hp: gameMode.enemyHP });
                        }
                        if (j === 0 && length >= 3 && Math.random() < 0.3) {
                            enemies.push({ x: currentX + 10, y: platformStartY - 30, width: 30, height: 30, type: 'spike' });
                        }
                        currentX += TILE_SIZE;
                    }
                    if (length > 3) currentX += TILE_SIZE * 2;
                } else {
                    currentX += TILE_SIZE * 3;
                    let pX = currentX;
                    let pY = canvas.height - TILE_SIZE * (Math.floor(Math.random() * 3) + 3);
                    platforms.push({ x: pX, y: pY, width: TILE_SIZE * 2, height: TILE_SIZE });
                    if (Math.random() < 0.5) enemies.push({ x: pX + 10, y: pY - 30, width: 30, height: 30, type: 'spike' });
                    if (Math.random() < 0.5) targets.push({ x: pX + TILE_SIZE, y: pY - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, hp: gameMode.enemyHP });
                    currentX += TILE_SIZE * 2;
                }
                currentX += TILE_SIZE; 
            }
        }

        // –§–ò–ó–ò–ö–ê (5.0.2)
        function checkCollision(r1, r2) {
            return (r1.x < r2.x + r2.width && r1.x + r1.width > r2.x && r1.y < r2.y + r2.height && r1.y + r1.height > r2.y);
        }

        function handleSolidCollision(r1, r2) {
            if (!checkCollision(r1, r2)) return false;
            const dx = (r1.x + r1.width / 2) - (r2.x + r2.width / 2);
            const dy = (r1.y + r1.height / 2) - (r2.y + r2.height / 2);
            const overlapX = (r1.width / 2 + r2.width / 2) - Math.abs(dx);
            const overlapY = (r1.height / 2 + r2.height / 2) - Math.abs(dy);
            
            if (overlapX < overlapY) {
                if (dx > 0) r1.x += overlapX; else r1.x -= overlapX;
                r1.vx = 0;
            } else {
                if (dy > 0) { r1.y += overlapY; r1.vy = 0; } 
                else { r1.y -= overlapY; r1.vy = 0; r1.grounded = true; r1.jumpsLeft = r1.maxJumps; }
            }
            return true;
        }

        function shoot() {
            if (gameState !== 'PLAYING' || !canShoot) return;
            const bSpeed = player.facingRight ? 15 : -15; 
            bullets.push({ 
                x: player.x + player.width / 2, y: player.y + player.height / 2 - 5, 
                vx: bSpeed, width: 20, height: 10, life: 60, 
                color: currentBulletColor, shape: currentBulletShape 
            });
            canShoot = false;
            player.cooldownTimer = shootCooldown; 
        }

        function update() {
            if (gameState !== 'PLAYING') return;
            if (gameMode.isAuto) runAutopilot();

            if (keys.shoot) shoot();
            if (player.cooldownTimer > 0) player.cooldownTimer--; else if (player.cooldownTimer === 0) canShoot = true;

            // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞
            let moveSpeed = player.speed * gameMode.speedMult;

            if (keys.left && !gameMode.isAuto) { player.vx = -moveSpeed; player.facingRight = false; } 
            else if (keys.right) { player.vx = moveSpeed; player.facingRight = true; } 
            else { player.vx = 0; }

            if (keys.up) {
                if (player.grounded) { player.vy = player.jumpPower; player.grounded = false; player.jumpsLeft--; } 
                else if (player.jumpsLeft > 0 && !gameMode.isAuto) { player.vy = player.jumpPower; player.jumpsLeft--; keys.up = false; } // –§–∏–∫—Å –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ
                else if (gameMode.isAuto && player.jumpsLeft > 0 && player.vy > 0) { player.vy = player.jumpPower; player.jumpsLeft--; } // –ò–ò –¥–≤–æ–π–Ω–æ–π
            }

            player.vy += GRAVITY;
            if(player.vy > TERMINAL_VELOCITY) player.vy = TERMINAL_VELOCITY;
            player.x += player.vx; player.y += player.vy;

            // –ü–∞—Å—Ö–∞–ª–∫–∞
            if (!pusheenSpawned && player.x < 50) { pusheenSpawned = true; enemies.push(pusheenEnemy); showChat('Pusheen: "—è –≤–∏–∂—É —Ç–µ–±—è. –ê —Ç—ã –º–µ–Ω—è?"'); }
            if (pusheenSpawned && !pusheenDefeated && pusheenEnemy.hp <= 0) {
                 pusheenDefeated = true; showChat('–ò–≥—Ä–æ–∫: "–î–∞–∂–µ –Ω–µ –≤—Å–ø–æ—Ç–µ–ª!"', 2500); setTimeout(() => showChat('Pusheen: "–ø—Ä–∏–∏–≤–µ–µ–µ—Ç!!"'), 3000);
            }

            player.grounded = false;
            platforms.forEach(p => handleSolidCollision(player, p));
            targets.forEach(t => handleSolidCollision(player, t));

            if (player.y > canvas.height + 100) takeDamage(3);
            const currentBlock = Math.floor(player.x / TILE_SIZE);
            if (currentBlock > lastScoredBlock + 3) { score += 10; lastScoredBlock = currentBlock; }

            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i]; b.x += b.vx; b.life--;
                let hit = false;
                for (let j = targets.length - 1; j >= 0; j--) {
                    let t = targets[j];
                    if (checkCollision(b, t)) { t.hp--; score += 5; hit = true; if (t.hp <= 0) { targets.splice(j, 1); score += 50; } break; }
                }
                if (pusheenSpawned && !pusheenDefeated && checkCollision(b, pusheenEnemy)) { pusheenEnemy.hp--; score += 1; hit = true; }
                if (b.life <= 0 || hit) bullets.splice(i, 1);
            }

            if (player.invulnerable > 0) player.invulnerable--;
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                if (checkCollision(player, e)) {
                    if (e.type === 'spike') { takeDamage(1); break; }
                    else if (e.type === 'pusheen' && !pusheenDefeated) { takeDamage(3); break; }
                }
                if (e.type === 'pusheen' && pusheenDefeated) enemies.splice(i, 1);
            }

            let targetCamX = player.x - canvas.width / 2 + player.width / 2;
            if (targetCamX < 0) targetCamX = 0;
            cameraX += (targetCamX - cameraX) * 0.1; 
        }

        function takeDamage(amount) {
            if (player.invulnerable > 0) return;
            player.hp -= amount; player.invulnerable = 60; player.vy = -5; updateHearts();
            if (player.hp <= 0) {
                gameState = 'GAMEOVER';
                if (score > highScore) { highScore = score; localStorage.setItem('burr_highScore', highScore); }
                document.getElementById('gameOverText').textContent = `–°—á–µ—Ç: ${score} | –†–µ–∫–æ—Ä–¥: ${highScore}`;
                document.getElementById('gameOverModal').style.display = 'flex';
                document.getElementById('controls').style.display = 'none';
                document.getElementById('autopilotToggle').style.display = 'none';
            }
        }

        function showChat(message, duration = 2000) {
            chatBox.textContent = message; chatBox.style.opacity = '1';
            setTimeout(() => { chatBox.style.opacity = '0'; }, duration);
        }

        function updateHearts() {
            const ui = document.getElementById('uiLayer'); ui.innerHTML = '';
            for(let i=0; i<player.hp; i++) {
                const h = document.createElement('span'); h.className = 'heart'; h.innerHTML = '‚ô•Ô∏è'; ui.appendChild(h);
            }
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-cameraX, 0);

            // –ó–µ–º–ª—è
            for (let p of platforms) {
                if (assets.ground.complete && assets.ground.naturalHeight !== 0) ctx.drawImage(assets.ground, p.x, p.y, p.width, p.height);
                else { ctx.fillStyle = '#654321'; ctx.fillRect(p.x, p.y, p.width, p.height); ctx.fillStyle = '#00FF00'; ctx.fillRect(p.x, p.y, p.width, 10); }
            }
            // –¶–µ–ª–∏
            for (let t of targets) {
                ctx.fillStyle = `rgba(0, 0, 255, ${t.hp / gameMode.enemyHP})`; 
                ctx.fillRect(t.x, t.y, t.width, t.height);
                if (assets.ground.complete && assets.ground.naturalHeight !== 0) { ctx.globalAlpha = 0.2; ctx.drawImage(assets.ground, t.x, t.y, t.width, t.height); ctx.globalAlpha = 1.0; }
                ctx.fillStyle = 'white'; ctx.font = 'bold 20px monospace'; ctx.fillText(t.hp, t.x + t.width/2 - 5, t.y + t.height/2 + 5);
            }
            // –®–∏–ø—ã
            for (let e of enemies) {
                if(e.type === 'spike') {
                    if (assets.spike.complete && assets.spike.naturalHeight !== 0) ctx.drawImage(assets.spike, e.x, e.y, e.width, e.height);
                    else { ctx.fillStyle = 'purple'; ctx.beginPath(); ctx.moveTo(e.x, e.y+e.height); ctx.lineTo(e.x+e.width/2, e.y); ctx.lineTo(e.x+e.width, e.y+e.height); ctx.fill(); }
                } else if (e.type === 'pusheen' && !pusheenDefeated) {
                    ctx.fillStyle = 'darkred'; ctx.fillRect(e.x, e.y, e.width, e.height);
                    ctx.fillStyle = 'white'; ctx.font = '16px monospace'; ctx.fillText(`BOSS`, e.x, e.y-5);
                }
            }

            // –ü—É–ª–∏ (–ö–∞—Å—Ç–æ–º–Ω—ã–µ)
            for (let b of bullets) {
                ctx.fillStyle = b.color;
                if(b.shape === 's_circle') { ctx.beginPath(); ctx.arc(b.x, b.y+b.height/2, b.height/2, 0, Math.PI*2); ctx.fill(); }
                else if (b.shape === 's_tri') {
                    ctx.beginPath();
                    if(b.vx > 0) { ctx.moveTo(b.x, b.y); ctx.lineTo(b.x+b.width, b.y+b.height/2); ctx.lineTo(b.x, b.y+b.height); }
                    else { ctx.moveTo(b.x+b.width, b.y); ctx.lineTo(b.x, b.y+b.height/2); ctx.lineTo(b.x+b.width, b.y+b.height); }
                    ctx.fill();
                } else { ctx.fillRect(b.x, b.y, b.width, b.height); }
            }

            // –ò–≥—Ä–æ–∫
            if (player.invulnerable % 10 < 5) { ctx.fillStyle = currentSkinColor; ctx.fillRect(player.x, player.y, player.width, player.height); }

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä—ã–∂–∫–∞
            if (!player.grounded && player.jumpsLeft > 0) {
                const bx = player.x + 10; const by = player.y - 15;
                ctx.fillStyle = 'rgba(255,0,0,0.5)'; ctx.fillRect(bx, by, 30, 5);
                if(player.jumpsLeft === 1) { ctx.fillStyle = '#00FF00'; ctx.fillRect(bx, by, 15, 5); }
            }

            ctx.restore();
            // HUD
            ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.font = 'bold 16px monospace';
            ctx.fillText('V5.1 Beta', canvas.width - 100, 20);
            ctx.fillStyle = '#fff';
            ctx.fillText(`–°–ß–ï–¢: ${score}`, 10, 50);
            ctx.fillText(`–†–ï–ñ–ò–ú: ${gameMode.type.toUpperCase()}`, 10, 70);
        }

        function loop() {
            update(); draw();
            if (gameState === 'PLAYING') requestAnimationFrame(loop);
        }
        
        window.onload = function() { showMenu(); };
    </script>
</body>
</html>
